-- Create the database and select it
CREATE DATABASE IF NOT EXISTS CompanyDB;
USE CompanyDB;

-- Disable foreign key checks so we can drop tables in any order
SET FOREIGN_KEY_CHECKS = 0;

-- Drop tables in reverse dependency order
DROP TABLE IF EXISTS WORKS_ON;
DROP TABLE IF EXISTS PROJECT;
DROP TABLE IF EXISTS DLOCATION;
DROP TABLE IF EXISTS EMPLOYEE;
DROP TABLE IF EXISTS DEPARTMENT;

-- Re-enable foreign key checks
SET FOREIGN_KEY_CHECKS = 1;

-- Create DEPARTMENT table (initially with 3 columns)
CREATE TABLE DEPARTMENT (
  DNO VARCHAR(20) PRIMARY KEY,
  DNAME VARCHAR(20),
  MGRSTARTDATE DATE
) ENGINE=InnoDB;

-- Create EMPLOYEE table
CREATE TABLE EMPLOYEE (
  SSN VARCHAR(20) PRIMARY KEY,
  FNAME VARCHAR(20),
  LNAME VARCHAR(20),
  ADDRESS VARCHAR(20),
  SEX CHAR(1),
  SALARY INT,
  SUPERSSN VARCHAR(20),
  DNO VARCHAR(20),
  FOREIGN KEY (SUPERSSN) REFERENCES EMPLOYEE(SSN),
  FOREIGN KEY (DNO) REFERENCES DEPARTMENT(DNO)
) ENGINE=InnoDB;

-- Alter DEPARTMENT to add manager SSN (MGRSSN) column and its foreign key
ALTER TABLE DEPARTMENT ADD COLUMN MGRSSN VARCHAR(20);
ALTER TABLE DEPARTMENT ADD FOREIGN KEY (MGRSSN) REFERENCES EMPLOYEE(SSN);

-- Create DLOCATION table with ON DELETE CASCADE on DNO
CREATE TABLE DLOCATION (
  DLOC VARCHAR(20),
  DNO VARCHAR(20),
  PRIMARY KEY (DNO, DLOC),
  FOREIGN KEY (DNO) REFERENCES DEPARTMENT(DNO) ON DELETE CASCADE
) ENGINE=InnoDB;

-- Create PROJECT table
CREATE TABLE PROJECT (
  PNO INT PRIMARY KEY,
  PNAME VARCHAR(20),
  PLOCATION VARCHAR(20),
  DNO VARCHAR(20),
  FOREIGN KEY (DNO) REFERENCES DEPARTMENT(DNO)
) ENGINE=InnoDB;

-- Create WORKS_ON table
CREATE TABLE WORKS_ON (
  HOURS INT,
  SSN VARCHAR(20),
  PNO INT,
  PRIMARY KEY (SSN, PNO),
  FOREIGN KEY (SSN) REFERENCES EMPLOYEE(SSN),
  FOREIGN KEY (PNO) REFERENCES PROJECT(PNO)
) ENGINE=InnoDB;

-- Insert data into EMPLOYEE
INSERT INTO EMPLOYEE (SSN, FNAME, LNAME, ADDRESS, SEX, SALARY) VALUES
('RNSECE01','JOHN','SCOTT','BANGALORE','M',450000);
INSERT INTO EMPLOYEE (SSN, FNAME, LNAME, ADDRESS, SEX, SALARY) VALUES
('RNSCSE01','JAMES','SMITH','BANGALORE','M',500000);
INSERT INTO EMPLOYEE (SSN, FNAME, LNAME, ADDRESS, SEX, SALARY) VALUES
('RNSCSE02','HEARN','BAKER','BANGALORE','M',700000);
INSERT INTO EMPLOYEE (SSN, FNAME, LNAME, ADDRESS, SEX, SALARY) VALUES
('RNSCSE03','EDWARD','SCOTT','MYSORE','M',500000);
INSERT INTO EMPLOYEE (SSN, FNAME, LNAME, ADDRESS, SEX, SALARY) VALUES
('RNSCSE04','PAVAN','HEGDE','MANGALORE','M',650000);
INSERT INTO EMPLOYEE (SSN, FNAME, LNAME, ADDRESS, SEX, SALARY) VALUES
('RNSCSE05','GIRISH','MALYA','MYSORE','M',450000);
INSERT INTO EMPLOYEE (SSN, FNAME, LNAME, ADDRESS, SEX, SALARY) VALUES
('RNSCSE06','NEHA','SN','BANGALORE','F',800000);
INSERT INTO EMPLOYEE (SSN, FNAME, LNAME, ADDRESS, SEX, SALARY) VALUES
('RNSACC01','AHANA','K','MANGALORE','F',350000);
INSERT INTO EMPLOYEE (SSN, FNAME, LNAME, ADDRESS, SEX, SALARY) VALUES
('RNSACC02','SANTHOSH','KUMAR','MANGALORE','M',300000);
INSERT INTO EMPLOYEE (SSN, FNAME, LNAME, ADDRESS, SEX, SALARY) VALUES
('RNSISE01','VEENA','M','MYSORE','M',600000);
INSERT INTO EMPLOYEE (SSN, FNAME, LNAME, ADDRESS, SEX, SALARY) VALUES
('RNSIT01','NAGESH','HR','BANGALORE','M',500000);

-- Insert data into DEPARTMENT 
-- Note: Now DEPARTMENT has 4 columns (DNO, DNAME, MGRSTARTDATE, MGRSSN).
-- We provide NULL for MGRSSN.
INSERT INTO DEPARTMENT VALUES ('1','ACCOUNTS','2001-01-01', NULL);
INSERT INTO DEPARTMENT VALUES ('2','IT','2016-08-01', NULL);
INSERT INTO DEPARTMENT VALUES ('3','ECE','2008-06-01', NULL);
INSERT INTO DEPARTMENT VALUES ('4','ISE','2015-08-01', NULL);
INSERT INTO DEPARTMENT VALUES ('5','CSE','2001-06-01', NULL);

-- Update EMPLOYEE with department numbers and supervisor info
UPDATE EMPLOYEE SET SUPERSSN = NULL, DNO = '3' WHERE SSN = 'RNSECE01';
UPDATE EMPLOYEE SET SUPERSSN = 'RNSCSE02', DNO = '5' WHERE SSN = 'RNSCSE01';
UPDATE EMPLOYEE SET SUPERSSN = 'RNSCSE03', DNO = '5' WHERE SSN = 'RNSCSE02';
UPDATE EMPLOYEE SET SUPERSSN = 'RNSCSE04', DNO = '5' WHERE SSN = 'RNSCSE03';
UPDATE EMPLOYEE SET DNO = '5', SUPERSSN = 'RNSCSE05' WHERE SSN = 'RNSCSE04';
UPDATE EMPLOYEE SET DNO = '5', SUPERSSN = 'RNSCSE06' WHERE SSN = 'RNSCSE05';
UPDATE EMPLOYEE SET DNO = '5', SUPERSSN = NULL WHERE SSN = 'RNSCSE06';
UPDATE EMPLOYEE SET DNO = '1', SUPERSSN = 'RNSACC02' WHERE SSN = 'RNSACC01';
UPDATE EMPLOYEE SET DNO = '1', SUPERSSN = NULL WHERE SSN = 'RNSACC02';
UPDATE EMPLOYEE SET DNO = '4', SUPERSSN = NULL WHERE SSN = 'RNSISE01';
UPDATE EMPLOYEE SET DNO = '2', SUPERSSN = NULL WHERE SSN = 'RNSIT01';

-- Update DEPARTMENT to set manager (MGRSSN)
UPDATE DEPARTMENT SET MGRSSN = 'RNSACC02' WHERE DNO = '1';
UPDATE DEPARTMENT SET MGRSSN = 'RNSIT01'  WHERE DNO = '2';
UPDATE DEPARTMENT SET MGRSSN = 'RNSECE01' WHERE DNO = '3';
UPDATE DEPARTMENT SET MGRSSN = 'RNSISE01'  WHERE DNO = '4';
UPDATE DEPARTMENT SET MGRSSN = 'RNSCSE05'  WHERE DNO = '5';

-- Insert data into DLOCATION
INSERT INTO DLOCATION VALUES ('BANGALORE','1');
INSERT INTO DLOCATION VALUES ('BANGALORE','2');
INSERT INTO DLOCATION VALUES ('BANGALORE','3');
INSERT INTO DLOCATION VALUES ('MANGALORE','4');
INSERT INTO DLOCATION VALUES ('MANGALORE','5');

-- Insert data into PROJECT
INSERT INTO PROJECT VALUES (100,'IOT','BANGALORE','5');
INSERT INTO PROJECT VALUES (101,'CLOUD','BANGALORE','5');
INSERT INTO PROJECT VALUES (102,'BIGDATA','BANGALORE','5');
INSERT INTO PROJECT VALUES (103,'SENSORS','BANGALORE','3');
INSERT INTO PROJECT VALUES (104,'BANK MANAGEMENT','BANGALORE','1');
INSERT INTO PROJECT VALUES (105,'SALARYMANAGEMENT','BANGALORE','1');
INSERT INTO PROJECT VALUES (106,'OPENSTACK','BANGALORE','4');
INSERT INTO PROJECT VALUES (107,'SMARTCITY','BANGALORE','2');

-- Insert data into WORKS_ON
INSERT INTO WORKS_ON VALUES (4, 'RNSCSE01', 100);
INSERT INTO WORKS_ON VALUES (6, 'RNSCSE01', 101);
INSERT INTO WORKS_ON VALUES (8, 'RNSCSE01', 102);
INSERT INTO WORKS_ON VALUES (10, 'RNSCSE02', 100);
INSERT INTO WORKS_ON VALUES (3, 'RNSCSE04', 100);
INSERT INTO WORKS_ON VALUES (4, 'RNSCSE05', 101);
INSERT INTO WORKS_ON VALUES (5, 'RNSCSE06', 102);
INSERT INTO WORKS_ON VALUES (6, 'RNSCSE03', 102);
INSERT INTO WORKS_ON VALUES (7, 'RNSECE01', 103);
INSERT INTO WORKS_ON VALUES (5, 'RNSACC01', 104);
INSERT INTO WORKS_ON VALUES (6, 'RNSACC02', 105);
INSERT INTO WORKS_ON VALUES (4, 'RNSISE01', 106);
INSERT INTO WORKS_ON VALUES (10, 'RNSIT01', 107);

Q1:
(SELECT DISTINCT P.PNO
 FROM PROJECT P, DEPARTMENT D, EMPLOYEE E
 WHERE E.DNO = D.DNO
   AND D.MGRSSN = E.SSN
   AND E.LNAME = 'SCOTT')
UNION
(SELECT DISTINCT P1.PNO
 FROM PROJECT P1, WORKS_ON W, EMPLOYEE E1
 WHERE P1.PNO = W.PNO
   AND E1.SSN = W.SSN
   AND E1.LNAME = 'SCOTT');
Q2:
SELECT E.FNAME, E.LNAME, 1.1 * E.SALARY AS INCR_SAL
FROM EMPLOYEE E
JOIN WORKS_ON W ON E.SSN = W.SSN
JOIN PROJECT P ON W.PNO = P.PNO
WHERE P.PNAME = 'IOT';
Q3:
SELECT SUM(E.SALARY) AS Total_Salary,
       MAX(E.SALARY) AS Max_Salary,
       MIN(E.SALARY) AS Min_Salary,
       AVG(E.SALARY) AS Avg_Salary
FROM EMPLOYEE E
JOIN DEPARTMENT D ON E.DNO = D.DNO
WHERE D.DNAME = 'ACCOUNTS';
Q4:
SELECT E.FNAME, E.LNAME
FROM EMPLOYEE E
WHERE NOT EXISTS (
  SELECT 1
  FROM PROJECT P
  WHERE P.DNO = '5'
    AND NOT EXISTS (
      SELECT 1
      FROM WORKS_ON W
      WHERE W.SSN = E.SSN
        AND W.PNO = P.PNO
    )
);
Q5:
SELECT D.DNO, COUNT(*) AS HighSalaryCount
FROM DEPARTMENT D
JOIN EMPLOYEE E ON D.DNO = E.DNO
WHERE E.SALARY > 600000
  AND D.DNO IN (
    SELECT E1.DNO
    FROM EMPLOYEE E1
    GROUP BY E1.DNO
    HAVING COUNT(*) > 5
  )
GROUP BY D.DNO;
