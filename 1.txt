-- Library Database Script

CREATE DATABASE LibraryDB;
USE LibraryDB;

CREATE TABLE PUBLISHER (
    NAME VARCHAR(20) PRIMARY KEY,
    PHONE VARCHAR(15),
    ADDRESS VARCHAR(50)
);

CREATE TABLE BOOK (
    BOOK_ID INT PRIMARY KEY,
    TITLE VARCHAR(50),
    PUB_YEAR VARCHAR(10),
    PUBLISHER_NAME VARCHAR(20),
    FOREIGN KEY (PUBLISHER_NAME) REFERENCES PUBLISHER(NAME) ON DELETE CASCADE
);

CREATE TABLE BOOK_AUTHORS (
    AUTHOR_NAME VARCHAR(20),
    BOOK_ID INT,
    PRIMARY KEY (BOOK_ID, AUTHOR_NAME),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE
);

CREATE TABLE LIBRARY_BRANCH (
    BRANCH_ID INT PRIMARY KEY,
    BRANCH_NAME VARCHAR(50),
    ADDRESS VARCHAR(50)
);

CREATE TABLE BOOK_COPIES (
    BOOK_ID INT,
    BRANCH_ID INT,
    NO_OF_COPIES INT,
    PRIMARY KEY (BOOK_ID, BRANCH_ID),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
    FOREIGN KEY (BRANCH_ID) REFERENCES LIBRARY_BRANCH(BRANCH_ID) ON DELETE CASCADE
);

CREATE TABLE CARD (
    CARD_NO INT PRIMARY KEY
);

CREATE TABLE BOOK_LENDING (
    BOOK_ID INT,
    BRANCH_ID INT,
    CARD_NO INT,
    DATE_OUT DATE,
    DUE_DATE DATE,
    PRIMARY KEY (BOOK_ID, BRANCH_ID, CARD_NO),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
    FOREIGN KEY (BRANCH_ID) REFERENCES LIBRARY_BRANCH(BRANCH_ID) ON DELETE CASCADE,
    FOREIGN KEY (CARD_NO) REFERENCES CARD(CARD_NO) ON DELETE CASCADE
);

INSERT INTO PUBLISHER VALUES ('PEARSON', '123-456-7890', 'NEW YORK');
INSERT INTO PUBLISHER VALUES ('MCGRAW', '234-567-8901', 'CHICAGO');
INSERT INTO PUBLISHER VALUES ('OXFORD', '345-678-9012', 'LONDON');

INSERT INTO BOOK VALUES (1, 'DATABASE SYSTEMS', '2020', 'PEARSON');
INSERT INTO BOOK VALUES (2, 'NETWORKS', '2019', 'MCGRAW');
INSERT INTO BOOK VALUES (3, 'ALGORITHMS', '2021', 'OXFORD');
INSERT INTO BOOK VALUES (4, 'MACHINE LEARNING', '2018', 'PEARSON');
INSERT INTO BOOK VALUES (5, 'PYTHON', '2022', 'MCGRAW');

INSERT INTO BOOK_AUTHORS VALUES ('SMITH', 1);
INSERT INTO BOOK_AUTHORS VALUES ('JONES', 2);
INSERT INTO BOOK_AUTHORS VALUES ('WILSON', 3);
INSERT INTO BOOK_AUTHORS VALUES ('GARCIA', 4);
INSERT INTO BOOK_AUTHORS VALUES ('CHEN', 5);

INSERT INTO LIBRARY_BRANCH VALUES (1, 'CENTRAL', 'MAIN ST');
INSERT INTO LIBRARY_BRANCH VALUES (2, 'NORTH', 'FIRST AVE');
INSERT INTO LIBRARY_BRANCH VALUES (3, 'SOUTH', 'PARK RD');

INSERT INTO BOOK_COPIES VALUES (1, 1, 5);
INSERT INTO BOOK_COPIES VALUES (1, 2, 3);
INSERT INTO BOOK_COPIES VALUES (2, 1, 2);
INSERT INTO BOOK_COPIES VALUES (3, 3, 7);
INSERT INTO BOOK_COPIES VALUES (4, 2, 4);
INSERT INTO BOOK_COPIES VALUES (5, 1, 3);

INSERT INTO CARD VALUES (101);
INSERT INTO CARD VALUES (102);
INSERT INTO CARD VALUES (103);
INSERT INTO CARD VALUES (104);
INSERT INTO CARD VALUES (105);

INSERT INTO BOOK_LENDING VALUES (1, 1, 101, '2019-01-15', '2019-02-15');
INSERT INTO BOOK_LENDING VALUES (2, 1, 101, '2019-02-10', '2019-03-10');
INSERT INTO BOOK_LENDING VALUES (3, 3, 101, '2019-03-05', '2019-04-05');
INSERT INTO BOOK_LENDING VALUES (4, 2, 101, '2019-04-20', '2019-05-20');
INSERT INTO BOOK_LENDING VALUES (1, 2, 102, '2019-03-15', '2019-04-15');
INSERT INTO BOOK_LENDING VALUES (3, 3, 103, '2019-05-05', '2019-06-05');

-- Query 1
SELECT B.BOOK_ID, B.TITLE, B.PUBLISHER_NAME, A.AUTHOR_NAME, C.NO_OF_COPIES, C.BRANCH_ID
FROM BOOK B
JOIN BOOK_AUTHORS A ON B.BOOK_ID = A.BOOK_ID
JOIN BOOK_COPIES C ON B.BOOK_ID = C.BOOK_ID
JOIN LIBRARY_BRANCH L ON C.BRANCH_ID = L.BRANCH_ID;

-- Query 2
SELECT CARD_NO
FROM BOOK_LENDING
WHERE DATE_OUT BETWEEN '2019-01-01' AND '2019-06-30'
GROUP BY CARD_NO
HAVING COUNT(*) > 3;

-- Query 3
DELETE FROM BOOK WHERE BOOK_ID = 3;

-- Query 4
DROP VIEW IF EXISTS BOOK_BY_YEAR;
CREATE VIEW BOOK_BY_YEAR AS
SELECT * FROM BOOK
WHERE PUB_YEAR = '2018'
UNION ALL
SELECT * FROM BOOK
WHERE PUB_YEAR = '2019'
UNION ALL
SELECT * FROM BOOK
WHERE PUB_YEAR = '2020'
UNION ALL
SELECT * FROM BOOK
WHERE PUB_YEAR = '2021'
UNION ALL
SELECT * FROM BOOK
WHERE PUB_YEAR = '2022';

-- Query 5
CREATE VIEW V_AVAILABLE_BOOKS AS
SELECT B.BOOK_ID, B.TITLE, C.BRANCH_ID, C.NO_OF_COPIES
FROM BOOK B
JOIN BOOK_COPIES C ON B.BOOK_ID = C.BOOK_ID;